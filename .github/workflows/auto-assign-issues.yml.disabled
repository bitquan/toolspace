name: "Auto-Assign New Issues to Copilot"

on:
    issues:
        types: [opened]
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Run in dry-run mode (preview only)"
                required: false
                default: "false"
                type: choice
                options:
                    - "true"
                    - "false"
            max_age_hours:
                description: "Maximum age of issues to process (hours)"
                required: false
                default: "24"
                type: string

permissions:
    issues: write
    contents: read

jobs:
    auto-assign:
        name: "Auto-assign to Copilot Pipeline"
        runs-on: ubuntu-latest

        steps:
            - name: "Checkout Repository"
              uses: actions/checkout@v4

            - name: "Setup Node.js"
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"

            - name: "Install Dependencies"
              run: npm ci

            - name: "Auto-assign New Issue (Event Trigger)"
              if: github.event_name == 'issues'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
              run: |
                  echo "INFO: Processing newly created issue #${{ github.event.issue.number }}"
                  echo "INFO: Issue title: ${{ github.event.issue.title }}"
                  echo "INFO: Created by: ${{ github.event.issue.user.login }}"

                  # Use the manual assignment script for the specific issue
                  node scripts/assign-to-copilot.mjs ${{ github.event.issue.number }}

            - name: "Auto-assign Recent Issues (Manual Trigger)"
              if: github.event_name == 'workflow_dispatch'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
              run: |
                  echo "INFO: Manual auto-assignment trigger"
                  echo "INFO: Dry run: ${{ github.event.inputs.dry_run }}"
                  echo "INFO: Max age: ${{ github.event.inputs.max_age_hours }} hours"

                  # Build command with options
                  CMD="node scripts/auto-assign-new-issues.mjs"

                  if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
                    CMD="$CMD --dry-run"
                  fi

                  if [ -n "${{ github.event.inputs.max_age_hours }}" ]; then
                    CMD="$CMD --max-age=${{ github.event.inputs.max_age_hours }}"
                  fi

                  echo "INFO: Executing: $CMD"
                  $CMD

            - name: "Upload Assignment Logs"
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: assignment-logs-${{ github.run_number }}
                  path: logs/
                  retention-days: 30

            - name: "Notify on Failure"
              if: failure()
              run: |
                  echo "ERROR: Auto-assignment workflow failed"
                  echo "Check the workflow logs for details"
                  echo "Scripts may be missing or there may be API issues"
                  echo "Consider running manual assignment as fallback"
