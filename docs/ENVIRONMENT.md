# Production Environment Configuration

Single production environment configuration for Firebase and Stripe integration.

## Environment Overview

**Strategy**: Single Environment
**Firebase Project**: `your-prod-project-id`
**Stripe Account**: Live/Production
**Domain**: `app.example.com`

## Environment Mapping

| Service       | Environment | Configuration                                         |
| ------------- | ----------- | ----------------------------------------------------- |
| **Firebase**  | Production  | `your-prod-project-id`                                |
| **Hosting**   | Production  | `app.example.com`                                     |
| **Functions** | Production  | `us-central1-your-prod-project-id.cloudfunctions.net` |
| **Firestore** | Production  | Production mode with security rules                   |
| **Storage**   | Production  | `your-prod-project-id.appspot.com`                    |
| **Auth**      | Production  | Live OAuth providers                                  |
| **Stripe**    | Production  | Live keys (`sk_live_***`)                             |

## Secret Management

### GitHub Secrets

All secrets stored in GitHub repository settings → Secrets and variables → Actions:

```bash
# Firebase Configuration
FIREBASE_SERVICE_ACCOUNT     # Service account JSON (base64 encoded)
FIREBASE_PROJECT_ID          # your-prod-project-id

# Stripe Configuration
STRIPE_SECRET_KEY           # sk_live_***
STRIPE_WEBHOOK_SECRET       # whsec_***

# Domain Configuration
PROD_DOMAIN                 # app.example.com
```

### Firebase Functions Runtime Config

```bash
# Set production configuration
firebase functions:config:set \
  stripe.secret_key="sk_live_***" \
  stripe.webhook_secret="whsec_***" \
  --project your-prod-project-id

# View current configuration
firebase functions:config:get --project your-prod-project-id
```

### Local Development Environment

```bash
# .env file for local development
FIREBASE_PROJECT_ID=your-prod-project-id
STRIPE_SECRET_KEY=sk_test_***
STRIPE_WEBHOOK_SECRET=whsec_***
NODE_ENV=development
```

## Configuration Files

### Firebase Configuration

```javascript
// firebase.js (generated by Firebase CLI)
const firebaseConfig = {
  apiKey: "AIza***",
  authDomain: "your-prod-project-id.firebaseapp.com",
  projectId: "your-prod-project-id",
  storageBucket: "your-prod-project-id.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abc123",
};
```

### Pricing Configuration

```json
// config/pricing.json
{
  "plans": {
    "pro": {
      "stripePriceId": "STRIPE_PRICE_PRO_MONTH"
    },
    "pro_plus": {
      "stripePriceId": "STRIPE_PRICE_PRO_PLUS_MONTH"
    }
  }
}
```

## Key Rotation Procedures

### Firebase Service Account

**Frequency**: Every 90 days or when compromised

```bash
# 1. Create new service account
gcloud iam service-accounts create toolspace-prod-new \
  --display-name="Toolspace Production (New)"

# 2. Grant required permissions
gcloud projects add-iam-policy-binding your-prod-project-id \
  --member="serviceAccount:toolspace-prod-new@your-prod-project-id.iam.gserviceaccount.com" \
  --role="roles/firebase.admin"

# 3. Generate new key
gcloud iam service-accounts keys create service-account-new.json \
  --iam-account=toolspace-prod-new@your-prod-project-id.iam.gserviceaccount.com

# 4. Update GitHub secret
# Encode to base64: cat service-account-new.json | base64 -w 0
# Update FIREBASE_SERVICE_ACCOUNT secret

# 5. Test deployment with new key

# 6. Remove old service account
gcloud iam service-accounts delete toolspace-prod@your-prod-project-id.iam.gserviceaccount.com
```

### Stripe Keys

**Frequency**: Every 6 months or when compromised

```bash
# 1. Generate new keys in Stripe Dashboard
# 2. Update production environment
firebase functions:config:set \
  stripe.secret_key="sk_live_NEW_KEY" \
  --project your-prod-project-id

# 3. Update GitHub secret
# Update STRIPE_SECRET_KEY in repository settings

# 4. Deploy functions with new keys
firebase deploy --only functions --project your-prod-project-id

# 5. Update webhook secret if needed
firebase functions:config:set \
  stripe.webhook_secret="whsec_NEW_SECRET" \
  --project your-prod-project-id
```

### Webhook Secret Rotation

```bash
# 1. Generate new webhook endpoint secret in Stripe
# 2. Update configuration
firebase functions:config:set \
  stripe.webhook_secret="whsec_NEW_SECRET" \
  --project your-prod-project-id

# 3. Update GitHub secret
# Update STRIPE_WEBHOOK_SECRET

# 4. Deploy functions
firebase deploy --only functions

# 5. Test webhook delivery
stripe trigger customer.subscription.created
```

## Zero-Downtime Key Rotation

### Gradual Key Migration

For critical services, implement gradual migration:

```typescript
// Support both old and new keys during transition
function validateWebhookSignature(payload: string, signature: string): boolean {
  const newSecret = functions.config().stripe.webhook_secret;
  const oldSecret = functions.config().stripe.webhook_secret_old;

  // Try new secret first
  try {
    stripe.webhooks.constructEvent(payload, signature, newSecret);
    return true;
  } catch (error) {
    // Fallback to old secret
    if (oldSecret) {
      try {
        stripe.webhooks.constructEvent(payload, signature, oldSecret);
        return true;
      } catch (fallbackError) {
        return false;
      }
    }
    return false;
  }
}
```

## Environment Validation

### Pre-Deployment Checks

```bash
#!/bin/bash
# validate-environment.sh

echo "🔍 Validating production environment..."

# Check Firebase project
CURRENT_PROJECT=$(firebase use --project your-prod-project-id 2>/dev/null | grep "Now using project" | cut -d" " -f4)
if [ "$CURRENT_PROJECT" != "your-prod-project-id" ]; then
  echo "❌ Wrong Firebase project: $CURRENT_PROJECT"
  exit 1
fi

# Check required secrets
if [ -z "$STRIPE_SECRET_KEY" ]; then
  echo "❌ STRIPE_SECRET_KEY not set"
  exit 1
fi

if [ -z "$FIREBASE_SERVICE_ACCOUNT" ]; then
  echo "❌ FIREBASE_SERVICE_ACCOUNT not set"
  exit 1
fi

# Validate Stripe key format
if [[ ! "$STRIPE_SECRET_KEY" =~ ^sk_live_ ]]; then
  echo "❌ Invalid Stripe key format (should start with sk_live_)"
  exit 1
fi

echo "✅ Environment validation passed"
```

### Runtime Health Checks

```typescript
// Health check endpoint
export const healthCheck = functions.https.onRequest(async (req, res) => {
  const health = {
    status: "healthy",
    timestamp: new Date().toISOString(),
    environment: {
      project: process.env.GCLOUD_PROJECT,
      node_version: process.version,
      function_name: process.env.FUNCTION_NAME,
    },
    services: {},
  };

  // Check Firestore connection
  try {
    await admin.firestore().doc("health/check").get();
    health.services.firestore = "connected";
  } catch (error) {
    health.services.firestore = "error";
    health.status = "degraded";
  }

  // Check Stripe connection
  try {
    await stripe.accounts.retrieve();
    health.services.stripe = "connected";
  } catch (error) {
    health.services.stripe = "error";
    health.status = "degraded";
  }

  const statusCode = health.status === "healthy" ? 200 : 503;
  res.status(statusCode).json(health);
});
```

## Monitoring and Alerting

### Environment Drift Detection

```yaml
# Cloud Monitoring alert for configuration changes
displayName: "Environment Configuration Changed"
conditions:
  - displayName: "Function configuration updated"
    conditionThreshold:
      filter: 'resource.type="cloud_function" AND protoPayload.methodName="google.cloud.functions.v1.CloudFunctionsService.UpdateFunction"'
      comparison: COMPARISON_GREATER_THAN
      thresholdValue: 0
notification_channels: ["notification-channel-id"]
```

### Secret Expiration Alerts

```bash
# Add to CI/CD pipeline
function check_secret_expiration() {
  # Check service account key age
  KEY_DATE=$(gcloud iam service-accounts keys list \
    --iam-account=toolspace-prod@your-prod-project-id.iam.gserviceaccount.com \
    --format="value(validAfterTime)" | head -1)

  # Calculate days since creation
  DAYS_OLD=$(( ($(date +%s) - $(date -d "$KEY_DATE" +%s)) / 86400 ))

  if [ $DAYS_OLD -gt 75 ]; then
    echo "⚠️ Service account key is $DAYS_OLD days old - rotation needed"
  fi
}
```

## Troubleshooting

### Common Environment Issues

#### Invalid Project ID

```bash
# Verify current project
firebase use
firebase projects:list

# Switch to correct project
firebase use your-prod-project-id
```

#### Wrong Stripe Keys

```bash
# Check key format
echo $STRIPE_SECRET_KEY | grep -E "^sk_(live|test)_"

# Test key validity
stripe customers list --limit 1
```

#### Function Configuration Mismatch

```bash
# Check current configuration
firebase functions:config:get

# Reset configuration
firebase functions:config:unset stripe
firebase functions:config:set stripe.secret_key="sk_live_***"
```

### Environment Recovery

#### Complete Environment Reset

```bash
# 1. Backup current configuration
firebase functions:config:get > config-backup.json

# 2. Reset all configuration
firebase functions:config:unset --project your-prod-project-id

# 3. Restore from known good state
firebase functions:config:set \
  stripe.secret_key="sk_live_***" \
  stripe.webhook_secret="whsec_***"

# 4. Deploy and verify
firebase deploy --only functions
```

---

**Security Reminder**: Never commit secrets to version control. Always use environment variables or secure secret management systems.
